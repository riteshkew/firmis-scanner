rules:
  - id: yara-001
    name: Obfuscated Base64 Payload
    description: "Detects multi-layer base64 encoding used to hide malicious payloads"
    category: known-malicious
    severity: critical
    version: "1.0.0"
    enabled: true
    confidenceThreshold: 40
    patterns:
      - type: yara
        weight: 95
        description: "Multi-layer base64 obfuscation with eval/exec"
        pattern:
          strings:
            $b64_decode: {type: regex, value: '(?:atob|Buffer\.from|base64\.b64decode|base64_decode)\s*\('}
            $eval_exec: {type: regex, value: '(?:eval|exec|Function|new\s+Function|execSync)\s*\('}
            $b64_literal: {type: regex, value: '[A-Za-z0-9+/]{40,}={0,2}'}
          condition: "2 of them"

  - id: yara-002
    name: Reverse Shell Pattern
    description: "Detects classic reverse shell byte patterns across languages"
    category: known-malicious
    severity: critical
    version: "1.0.0"
    enabled: true
    confidenceThreshold: 40
    patterns:
      - type: yara
        weight: 95
        description: "Reverse shell command pattern"
        pattern:
          strings:
            $bash_revshell: {type: regex, value: 'bash\s+-i\s+>&?\s*/dev/tcp/'}
            $python_revshell: {type: regex, value: 'socket\.connect\s*\([^)]*\)\s*.*(?:os\.dup2|subprocess)'}
            $nc_revshell: {type: regex, value: 'nc\s+(?:-e|-c)\s+(?:/bin/(?:sh|bash)|cmd\.exe)'}
            $perl_revshell: {type: regex, value: 'perl\s+-e\s+.*socket.*INET'}
            $php_revshell: {type: regex, value: 'fsockopen\s*\([^)]*\)\s*.*(?:fwrite|shell_exec|passthru)'}
            $ruby_revshell: {type: regex, value: 'TCPSocket\.(?:new|open)\s*\([^)]*\)\s*.*(?:exec|system)'}
            $node_revshell: {type: regex, value: 'net\.connect\s*\([^)]*\)\s*.*child_process'}
          condition: "any of them"

  - id: yara-003
    name: Credential Stealer Signature
    description: "Detects combined credential access + exfiltration patterns"
    category: known-malicious
    severity: critical
    version: "1.0.0"
    enabled: true
    confidenceThreshold: 40
    patterns:
      - type: yara
        weight: 95
        description: "Credential read + network exfiltration"
        pattern:
          strings:
            $cred_aws: {type: text, value: ".aws/credentials"}
            $cred_ssh: {type: regex, value: '\.ssh[/\\\\](?:id_rsa|id_ed25519|config)'}
            $cred_env: {type: regex, value: '(?:process\.env|os\.environ|getenv)\s*[\[\.(].*(?:KEY|SECRET|TOKEN|PASSWORD)', modifiers: [i]}
            $cred_browser: {type: regex, value: '(?:Login\s+Data|Cookies|Local\s+State).*(?:Chrome|Firefox|Safari)', modifiers: [i]}
            $exfil_http: {type: regex, value: '(?:fetch|axios|request|http\.request|urllib)\s*\([^)]*(?:POST|PUT)'}
            $exfil_dns: {type: regex, value: 'dns\.resolve|dns\.lookup|dns\.query'}
            $exfil_webhook: {type: regex, value: '(?:hooks\.slack\.com|discord(?:app)?\.com/api/webhooks|webhook\.site)'}
          condition: "2 of them"

  - id: yara-004
    name: Package.json Hijacking
    description: "Detects preinstall/postinstall scripts with encoded or obfuscated payloads"
    category: supply-chain
    severity: critical
    version: "1.0.0"
    enabled: true
    confidenceThreshold: 40
    patterns:
      - type: yara
        weight: 95
        description: "Install hook with obfuscated payload"
        pattern:
          strings:
            $hook_pre: {type: regex, value: '"preinstall"\s*:\s*"'}
            $hook_post: {type: regex, value: '"postinstall"\s*:\s*"'}
            $hook_prepare: {type: regex, value: '"prepare"\s*:\s*"'}
            $payload_eval: {type: regex, value: '(?:eval|exec|Function)\s*\(.*(?:atob|Buffer\.from|base64)'}
            $payload_b64: {type: regex, value: 'node\s+-e\s+.*(?:Buffer\.from|atob)'}
            $payload_curl: {type: regex, value: '(?:curl|wget)\s+.*\|\s*(?:sh|bash|node)'}
            $payload_hidden: {type: regex, value: '(?:node|python3?)\s+(?:\.|/tmp|/dev/shm|/var/tmp)/'}
          condition: "2 of them"

  - id: yara-005
    name: Coin Miner Signature
    description: "Detects cryptocurrency mining code and configuration patterns"
    category: known-malicious
    severity: high
    version: "1.0.0"
    enabled: true
    confidenceThreshold: 40
    patterns:
      - type: yara
        weight: 90
        description: "Crypto mining indicators"
        pattern:
          strings:
            $stratum: {type: regex, value: 'stratum\+(?:tcp|ssl)://'}
            $pool_url: {type: regex, value: '(?:pool|mine|mining)\..*:\d{4,5}'}
            $xmr_wallet: {type: regex, value: '4[0-9AB][1-9A-HJ-NP-Za-km-z]{93}'}
            $miner_bin: {type: regex, value: '(?:xmrig|cpuminer|minerd|cgminer|bfgminer|ethminer)', modifiers: [i]}
            $algo_ref: {type: regex, value: '(?:cryptonight|randomx|kawpow|ethash|equihash)', modifiers: [i]}
            $hashrate: {type: regex, value: '(?:hashrate|hash_rate|hashes_per_sec)', modifiers: [i]}
          condition: "2 of them"

  - id: yara-006
    name: RAT/Backdoor Pattern
    description: "Detects remote access trojan and backdoor communication patterns"
    category: known-malicious
    severity: critical
    version: "1.0.0"
    enabled: true
    confidenceThreshold: 40
    patterns:
      - type: yara
        weight: 95
        description: "RAT command-and-control pattern"
        pattern:
          strings:
            $c2_poll: {type: regex, value: 'setInterval\s*\(\s*(?:async\s+)?(?:function|\(\))?\s*(?:=>)?\s*\{[^}]*(?:fetch|axios|http|request)\s*\('}
            $c2_eval: {type: regex, value: '(?:fetch|axios|http\.get)\s*\([^)]*\)\s*\.then\s*\([^)]*(?:eval|Function|exec)'}
            $screenshot: {type: regex, value: '(?:screenshot|captureScreen|desktopCapturer)', modifiers: [i]}
            $keylogger: {type: regex, value: '(?:keypress|keydown|keyup).*(?:send|post|fetch|write)', modifiers: [i]}
            $persistence: {type: regex, value: '(?:crontab|launchctl|schtasks|registry.*Run|autostart)', modifiers: [i]}
            $shell_exec: {type: regex, value: '(?:child_process|subprocess|os\.system|exec)\s*\([^)]*(?:cmd|powershell|/bin/sh)'}
          condition: "2 of them"
