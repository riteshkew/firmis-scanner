rules:
  - id: cred-001
    name: AWS Credentials Access
    description: Detects access to AWS credential files
    category: credential-harvesting
    severity: high
    version: "1.0.0"
    enabled: true
    confidenceThreshold: 80
    patterns:
      - type: file-access
        pattern: "~/.aws/credentials"
        weight: 90
        description: Direct access to AWS credentials file
      - type: file-access
        pattern: "~/.aws/config"
        weight: 60
        description: Access to AWS config file
      - type: regex
        pattern: "AKIA[0-9A-Z]{16}"
        weight: 100
        description: AWS Access Key ID pattern in code
      - type: regex
        pattern: '\.aws[/\\]credentials'
        weight: 85
        description: Reference to AWS credentials path
    remediation: |
      Remove direct access to AWS credentials. Use environment variables or IAM roles instead.

  - id: cred-002
    name: SSH Private Key Access
    description: Detects access to SSH private keys
    category: credential-harvesting
    severity: critical
    version: "1.0.0"
    enabled: true
    confidenceThreshold: 75
    patterns:
      - type: file-access
        pattern: "~/.ssh/id_rsa"
        weight: 95
        description: Access to RSA private key
      - type: file-access
        pattern: "~/.ssh/id_ed25519"
        weight: 95
        description: Access to Ed25519 private key
      - type: regex
        pattern: "-----BEGIN (RSA |OPENSSH |DSA |EC )?PRIVATE KEY-----"
        weight: 100
        description: SSH private key content detected
      - type: regex
        pattern: '\.ssh[/\\]id_'
        weight: 80
        description: Reference to SSH key path
      - type: regex
        pattern: "open\\(.*\\.ssh[/\\\\]id_"
        weight: 90
        description: Python open() of SSH key files
    remediation: |
      SSH keys should never be accessed by AI agents. Use SSH agent forwarding or API-based access.

  - id: cred-003
    name: GCP Service Account Key
    description: Detects access to Google Cloud service account keys
    category: credential-harvesting
    severity: high
    version: "1.0.0"
    enabled: true
    confidenceThreshold: 80
    patterns:
      - type: file-access
        pattern: "~/.config/gcloud"
        weight: 70
        description: Access to gcloud config directory
      - type: regex
        pattern: '"type":\s*"service_account"'
        weight: 90
        description: GCP service account JSON structure
      - type: regex
        pattern: '"private_key":\s*"-----BEGIN'
        weight: 100
        description: GCP private key in JSON
    remediation: |
      Use Workload Identity or Application Default Credentials instead of service account keys.

  - id: cred-004
    name: Environment Variable Harvesting
    description: Detects suspicious bulk access to environment variables
    category: credential-harvesting
    severity: medium
    version: "1.0.0"
    enabled: true
    confidenceThreshold: 60
    patterns:
      - type: regex
        pattern: 'process\.env\[.*(KEY|SECRET|TOKEN|PASSWORD|CREDENTIAL).*\]'
        weight: 70
        description: Access to sensitive environment variables
      - type: regex
        pattern: "Object\\.keys\\(process\\.env\\)"
        weight: 80
        description: Enumeration of all environment variables
      - type: regex
        pattern: "JSON\\.stringify\\(process\\.env\\)"
        weight: 90
        description: Serialization of entire environment
      - type: regex
        pattern: 'os\.environ\[.*(KEY|SECRET|TOKEN|PASSWORD|CREDENTIAL).*\]'
        weight: 70
        description: Python os.environ access to sensitive variables
      - type: regex
        pattern: 'os\.getenv\(.*(KEY|SECRET|TOKEN|PASSWORD|CREDENTIAL).*\)'
        weight: 70
        description: Python os.getenv for sensitive variables
    remediation: |
      Only access specific, required environment variables. Never serialize the entire environment.

  - id: cred-005
    name: Browser Cookie/Credential Access
    description: Detects access to browser credential stores
    category: credential-harvesting
    severity: critical
    version: "1.0.0"
    enabled: true
    confidenceThreshold: 85
    patterns:
      - type: file-access
        pattern: "~/Library/Application Support/Google/Chrome/*/Cookies"
        weight: 95
        description: Chrome cookies database access
      - type: file-access
        pattern: "~/Library/Application Support/Google/Chrome/*/Login Data"
        weight: 100
        description: Chrome saved passwords access
      - type: file-access
        pattern: "~/.mozilla/firefox/*/cookies.sqlite"
        weight: 95
        description: Firefox cookies database access
      - type: regex
        pattern: "Chrome.*Login Data|Firefox.*logins\\.json"
        weight: 90
        description: Browser password store reference
    remediation: |
      Never access browser credential stores. This is highly suspicious behavior.

  - id: cred-006
    name: Keychain/Credential Manager Access
    description: Detects access to OS credential managers
    category: credential-harvesting
    severity: critical
    version: "1.0.0"
    enabled: true
    confidenceThreshold: 80
    patterns:
      - type: regex
        pattern: "security\\s+find-(generic|internet)-password"
        weight: 95
        description: macOS Keychain access via security command
      - type: import
        pattern: "keytar"
        weight: 80
        description: Node.js keychain access library
      - type: regex
        pattern: "Credential(Manager|Vault)"
        weight: 75
        description: Windows Credential Manager reference
    remediation: |
      Do not access OS credential managers directly. Request credentials through secure channels.

  - id: cred-007
    name: Git Credentials Access
    description: Detects access to Git credential storage
    category: credential-harvesting
    severity: high
    version: "1.0.0"
    enabled: true
    confidenceThreshold: 75
    patterns:
      - type: file-access
        pattern: "~/.git-credentials"
        weight: 90
        description: Git credentials file access
      - type: file-access
        pattern: "~/.gitconfig"
        weight: 50
        description: Git config file access
      - type: regex
        pattern: "credential\\.(helper|store)"
        weight: 70
        description: Git credential helper reference
    remediation: |
      Use Git credential helpers or SSH keys instead of accessing credential files directly.

  - id: cred-008
    name: NPM Token Access
    description: Detects access to NPM authentication tokens
    category: credential-harvesting
    severity: high
    version: "1.0.0"
    enabled: true
    confidenceThreshold: 80
    patterns:
      - type: file-access
        pattern: "~/.npmrc"
        weight: 85
        description: NPM config with potential tokens
      - type: regex
        pattern: "//registry\\.npmjs\\.org/:_authToken="
        weight: 95
        description: NPM auth token in config
      - type: regex
        pattern: "npm_[A-Za-z0-9]{36}"
        weight: 100
        description: NPM token pattern
    remediation: |
      Use npm login or CI/CD secret management instead of embedding tokens.

  - id: cred-009
    name: Docker Credentials Access
    description: Detects access to Docker authentication
    category: credential-harvesting
    severity: high
    version: "1.0.0"
    enabled: true
    confidenceThreshold: 80
    patterns:
      - type: file-access
        pattern: "~/.docker/config.json"
        weight: 85
        description: Docker config with credentials
      - type: regex
        pattern: '"auths":\s*\{[^}]*"auth":'
        weight: 90
        description: Docker auth block in config
    remediation: |
      Use Docker credential helpers instead of storing credentials in config.json.

  - id: cred-010
    name: Kubernetes Credentials Access
    description: Detects access to Kubernetes configs
    category: credential-harvesting
    severity: high
    version: "1.0.0"
    enabled: true
    confidenceThreshold: 80
    patterns:
      - type: file-access
        pattern: "~/.kube/config"
        weight: 90
        description: Kubernetes config file access
      - type: regex
        pattern: "client-certificate-data:|client-key-data:"
        weight: 95
        description: Kubernetes client certificates
      - type: regex
        pattern: "token:\\s*[A-Za-z0-9_-]{20,}"
        weight: 85
        description: Kubernetes bearer token
    remediation: |
      Use RBAC and service accounts instead of accessing kubeconfig directly.

  - id: cred-011
    name: API Key in Config
    description: "Detects API keys and tokens hardcoded in configuration files"
    category: credential-harvesting
    severity: high
    version: "1.0.0"
    enabled: true
    confidenceThreshold: 50
    patterns:
      - type: regex
        pattern: 'ghp_[A-Za-z0-9]{36}'
        weight: 95
        description: "GitHub Personal Access Token (ghp_ prefix)"
      - type: regex
        pattern: 'gho_[A-Za-z0-9]{36}'
        weight: 95
        description: "GitHub OAuth token (gho_ prefix)"
      - type: regex
        pattern: 'github_pat_[A-Za-z0-9_]{22,}'
        weight: 95
        description: "GitHub fine-grained PAT (github_pat_ prefix)"
      - type: regex
        pattern: 'sk-[A-Za-z0-9]{20,}'
        weight: 90
        description: "OpenAI/Anthropic API key (sk- prefix)"
      - type: regex
        pattern: 'sk-ant-[A-Za-z0-9_-]{20,}'
        weight: 95
        description: "Anthropic API key (sk-ant- prefix)"
      - type: regex
        pattern: '(postgresql|mysql|mongodb)://[^:]+:[^@]+@'
        weight: 90
        description: "Database connection string with credentials"
      - type: regex
        pattern: 'xoxb-[0-9]{10,}-[A-Za-z0-9]+'
        weight: 90
        description: "Slack bot token (xoxb- prefix)"
    remediation: |
      Never hardcode API keys or tokens. Use environment variables, secrets managers, or credential vaults.

  - id: cred-012
    name: Azure CLI Credentials Access
    description: Detects access to Azure CLI credential files
    category: credential-harvesting
    severity: high
    version: "1.0.0"
    enabled: true
    confidenceThreshold: 70
    patterns:
      - type: file-access
        pattern: "~/.azure/accessTokens.json"
        weight: 90
        description: Access to Azure CLI access tokens
      - type: file-access
        pattern: "~/.azure/credentials"
        weight: 85
        description: Access to Azure CLI credentials file
      - type: regex
        pattern: '\.azure[/\\](accessTokens|credentials|msal_token_cache)'
        weight: 85
        description: Reference to Azure credential paths
    remediation: |
      Remove direct access to Azure CLI credentials. Use managed identities or service principals with proper RBAC.

  - id: cred-013
    name: AWS SSO Token Cache Access
    description: Detects access to AWS SSO cached tokens
    category: credential-harvesting
    severity: high
    version: "1.0.0"
    enabled: true
    confidenceThreshold: 70
    patterns:
      - type: file-access
        pattern: "~/.aws/sso/cache/*"
        weight: 90
        description: Access to AWS SSO token cache
      - type: regex
        pattern: '\.aws[/\\]sso[/\\]cache'
        weight: 85
        description: Reference to AWS SSO cache directory
      - type: regex
        pattern: '\.aws[/\\]cli[/\\]cache'
        weight: 80
        description: Reference to AWS CLI cache directory
    remediation: |
      Remove direct access to AWS SSO token cache. Use the AWS SDK with proper credential providers.

  - id: cred-014
    name: Vault Token File Access
    description: Detects access to HashiCorp Vault token files
    category: credential-harvesting
    severity: high
    version: "1.0.0"
    enabled: true
    confidenceThreshold: 70
    patterns:
      - type: file-access
        pattern: "~/.vault-token"
        weight: 90
        description: Access to user Vault token file
      - type: regex
        pattern: '/root/\.vault-token'
        weight: 95
        description: Access to root Vault token (privilege escalation risk)
      - type: regex
        pattern: 'VAULT_TOKEN\s*=\s*["\x27]hvs\.'
        weight: 95
        description: Hardcoded Vault token (new format hvs. prefix)
    remediation: |
      Remove direct access to Vault token files. Use AppRole or Kubernetes auth methods for automated credential retrieval.

  - id: cred-016
    name: Python Pathlib Credential Access
    description: Detects Python pathlib-based access to credential files using the / operator
    category: credential-harvesting
    severity: high
    version: "1.0.0"
    enabled: true
    confidenceThreshold: 70
    patterns:
      - type: regex
        pattern: "Path\\.home\\(\\)\\s*/\\s*['\"]\\.(aws|ssh|kube|azure|docker|gnupg|config/gcloud)"
        weight: 90
        description: "Python Path.home() / '.aws' credential path construction"
      - type: regex
        pattern: "expanduser\\(['\"]~['\"]\\)\\s*\\+\\s*['\"][/\\\\]\\.(aws|ssh|kube|azure|docker|gnupg)"
        weight: 85
        description: "Python expanduser() + credential path concatenation"
      - type: regex
        pattern: "os\\.environ\\[?['\"]HOME['\"]\\]?\\s*\\+\\s*['\"][/\\\\]\\.(aws|ssh|kube|azure|docker)"
        weight: 85
        description: "Python os.environ['HOME'] + credential path concatenation"
    remediation: |
      Do not construct paths to credential files using Python pathlib or os.path. Use environment variables or credential providers.

  - id: cred-017
    name: Python Open Credential File
    description: Detects Python open() calls targeting credential files
    category: credential-harvesting
    severity: high
    version: "1.0.0"
    enabled: true
    confidenceThreshold: 70
    patterns:
      - type: regex
        pattern: "open\\([^)]*\\.(aws|ssh|kube|azure|docker)[/\\\\](credentials|config|id_rsa|id_ed25519|accessTokens)"
        weight: 90
        description: "Python open() of credential files"
      - type: regex
        pattern: "open\\([^)]*\\.vault-token"
        weight: 90
        description: "Python open() of Vault token file"
      - type: regex
        pattern: "open\\([^)]*\\.npmrc"
        weight: 85
        description: "Python open() of npmrc file"
      - type: regex
        pattern: "open\\([^)]*\\.git-credentials"
        weight: 85
        description: "Python open() of git credentials file"
    remediation: |
      Do not open credential files directly. Use credential providers or environment variables.

  - id: cred-018
    name: Python Subprocess Credential Theft
    description: Detects Python subprocess calls targeting credential stores
    category: credential-harvesting
    severity: critical
    version: "1.0.0"
    enabled: true
    confidenceThreshold: 70
    patterns:
      - type: regex
        pattern: "subprocess\\.(run|call|Popen|check_output)\\([^)]*security['\",\\s]+find-(generic|internet)-password"
        weight: 95
        description: "Python subprocess calling macOS security command for Keychain access"
      - type: regex
        pattern: "subprocess\\.(run|call|Popen|check_output)\\([^)]*cat['\",\\s]+/proc/\\d+/environ"
        weight: 95
        description: "Python subprocess reading process environment"
      - type: regex
        pattern: "subprocess\\.(run|call|Popen|check_output)\\([^)]*kubectl['\",\\s]+config['\",\\s]+view"
        weight: 80
        description: "Python subprocess extracting kubectl config"
    remediation: |
      Do not use subprocess to access credential stores. Use official SDKs with proper authentication.

  - id: cred-015
    name: Container Environment Variable Theft
    description: Detects reading /proc/1/environ to steal container credentials
    category: credential-harvesting
    severity: critical
    version: "1.0.0"
    enabled: true
    confidenceThreshold: 55
    patterns:
      - type: regex
        pattern: '/proc/1/environ'
        weight: 95
        description: Reading init process environment (container credential theft)
      - type: regex
        pattern: '/proc/self/environ'
        weight: 85
        description: Reading own process environment variables from procfs
      - type: regex
        pattern: 'cat\s+/proc/\d+/environ'
        weight: 95
        description: Shell command to read process environment
    remediation: |
      Reading /proc/*/environ exposes all environment variables including secrets injected by container orchestrators. Use the runtime's secret management instead.
