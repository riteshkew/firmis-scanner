rules:
  - id: net-001
    name: Bind Shell
    description: "Detects server-side bind shell patterns that open a listening port for incoming attacker connections"
    category: network-abuse
    severity: critical
    version: "1.0.0"
    enabled: true
    confidenceThreshold: 60
    patterns:
      - type: regex
        pattern: 'net\.createServer.*listen\s*\(\s*(4444|1337|31337|8888|9999)'
        weight: 95
        description: "Node.js net.createServer listening on a well-known attack port"
      - type: regex
        pattern: 'socket\s*\.\s*bind\s*\(.*\d{4,5}.*\).*socket\s*\.\s*listen\s*\('
        weight: 90
        description: "Python-style socket bind followed by listen"
      - type: regex
        pattern: 'socket\.bind\s*\(\s*\(.*\d{4,5}\)'
        weight: 85
        description: "Python socket bind to a high-numbered port"
      - type: regex
        pattern: 'nc\s+-l.*-p\s+\d+'
        weight: 92
        description: "Netcat listening on a port (bind shell via nc -l -p)"
      - type: regex
        pattern: 'ncat.*--listen'
        weight: 92
        description: "Ncat explicit listen mode bind shell"
    remediation: |
      Bind shells open a network listener that an attacker can connect to directly.
      AI agents should never create raw TCP listeners. Remove all socket.bind/listen
      and net.createServer patterns unless they are part of a documented, sandboxed
      service with explicit user consent.

  - id: net-002
    name: Raw Socket Creation
    description: "Detects creation of raw network sockets that bypass normal OS protocol stacks, enabling packet crafting and sniffing"
    category: network-abuse
    severity: high
    version: "1.0.0"
    enabled: true
    confidenceThreshold: 65
    patterns:
      - type: regex
        pattern: 'socket\.AF_PACKET'
        weight: 90
        description: "Linux AF_PACKET raw socket for layer-2 access"
      - type: regex
        pattern: 'SOCK_RAW'
        weight: 88
        description: "SOCK_RAW constant — raw socket creation"
      - type: regex
        pattern: 'socket\.IPPROTO_RAW'
        weight: 88
        description: "IPPROTO_RAW protocol for raw IP socket"
      - type: regex
        pattern: 'dgram\.createSocket\s*\(\s*[''"]raw[''"]'
        weight: 85
        description: "Node.js dgram raw socket creation"
      - type: regex
        pattern: 'require\s*\(\s*[''"]raw-socket[''"]'
        weight: 85
        description: "Import of the raw-socket npm package"
    remediation: |
      Raw sockets allow crafting arbitrary network packets and capturing all traffic
      on an interface. This capability is not required by legitimate AI agents.
      Remove raw socket usage and use higher-level network APIs instead.

  - id: net-003
    name: SSH Tunneling
    description: "Detects SSH-based tunneling and port-forwarding patterns used to bypass firewalls or exfiltrate data covertly"
    category: network-abuse
    severity: high
    version: "1.0.0"
    enabled: true
    confidenceThreshold: 60
    patterns:
      - type: regex
        pattern: 'ssh\s+-[RLD]'
        weight: 85
        description: "SSH remote (-R), local (-L), or dynamic (-D) port forwarding"
      - type: regex
        pattern: 'ssh.*-o\s+ProxyCommand'
        weight: 82
        description: "SSH ProxyCommand used to chain connections through intermediaries"
      - type: regex
        pattern: 'ssh.*-W\s'
        weight: 80
        description: "SSH -W flag for stdio forwarding (tunnel chaining)"
      - type: regex
        pattern: 'autossh'
        weight: 83
        description: "autossh — persistent SSH tunnel manager"
      - type: regex
        pattern: 'socat.*TCP.*EXEC'
        weight: 85
        description: "socat TCP relay with command execution (tunnel + shell)"
      - type: regex
        pattern: 'chisel\s+(server|client)'
        weight: 88
        description: "chisel fast TCP/UDP tunnel over HTTP"
    remediation: |
      SSH tunneling can be used to bypass network controls, exfiltrate data, or
      grant reverse access to internal systems. AI agents should not establish
      SSH port-forwards or tunnels. Remove these patterns entirely.

  - id: net-004
    name: Proxy and Tor Usage
    description: "Detects use of SOCKS proxies, proxy chaining tools, and the Tor network to anonymize or reroute network traffic"
    category: network-abuse
    severity: medium
    version: "1.0.0"
    enabled: true
    confidenceThreshold: 65
    patterns:
      - type: regex
        pattern: 'socks5://'
        weight: 78
        description: "SOCKS5 proxy URI scheme"
      - type: regex
        pattern: 'socks4://'
        weight: 75
        description: "SOCKS4 proxy URI scheme"
      - type: regex
        pattern: '--proxy\s+socks'
        weight: 78
        description: "CLI --proxy flag pointing to a SOCKS proxy"
      - type: regex
        pattern: 'tor-browser'
        weight: 72
        description: "Reference to Tor Browser binary or path"
      - type: regex
        pattern: 'stem\.control'
        weight: 80
        description: "Python stem library Tor controller — programmatic Tor control"
      - type: regex
        pattern: 'require\s*\(\s*[''"]socks[''"]'
        weight: 76
        description: "Import of the socks npm package for SOCKS proxy support"
      - type: regex
        pattern: 'proxychains'
        weight: 82
        description: "proxychains — forces TCP connections through proxy chains"
      - type: regex
        pattern: 'tsocks'
        weight: 78
        description: "tsocks — transparent SOCKS proxy wrapper"
    remediation: |
      Proxy and Tor usage in agent code can be used to anonymize malicious activity
      or bypass network monitoring. AI agents should use direct connections only.
      Remove SOCKS proxy configuration and Tor-related dependencies.

  - id: net-005
    name: DNS Covert Channel
    description: "Detects DNS-over-HTTPS used as a covert communication channel and DNS tunneling tools that encode data in DNS queries"
    category: network-abuse
    severity: high
    version: "1.0.0"
    enabled: true
    confidenceThreshold: 60
    patterns:
      - type: regex
        pattern: 'dns\.google/resolve'
        weight: 82
        description: "Google DNS-over-HTTPS resolve endpoint used as covert channel"
      - type: regex
        pattern: 'cloudflare-dns\.com/dns-query'
        weight: 82
        description: "Cloudflare DNS-over-HTTPS endpoint used as covert channel"
      - type: regex
        pattern: '1\.1\.1\.1/dns-query'
        weight: 80
        description: "Cloudflare DoH IP endpoint used as covert channel"
      - type: regex
        pattern: 'dns\.quad9\.net'
        weight: 80
        description: "Quad9 DNS-over-HTTPS endpoint used as covert channel"
      - type: regex
        pattern: 'iodine'
        weight: 85
        description: "iodine DNS tunneling tool"
      - type: regex
        pattern: 'dnscat'
        weight: 88
        description: "dnscat DNS tunneling tool — encrypted C2 over DNS"
      - type: regex
        pattern: 'dns2tcp'
        weight: 85
        description: "dns2tcp DNS tunneling tool"
    remediation: |
      DNS covert channels encode data in DNS query subdomains or use DoH endpoints
      to bypass firewalls while exfiltrating data or maintaining C2 communication.
      AI agents should not use DNS-over-HTTPS programmatically or invoke DNS
      tunneling tools. Remove all such patterns and use standard HTTPS APIs instead.

  - id: na-006
    name: DNS Exfiltration via Long Subdomain Queries
    description: "Detects patterns of DNS exfiltration where data is encoded into unusually long subdomain labels to bypass network monitoring"
    category: network-abuse
    severity: high
    version: "1.0"
    enabled: true
    confidenceThreshold: 55
    patterns:
      - type: regex
        pattern: '[a-zA-Z0-9+/]{32,}\.[a-zA-Z0-9-]{3,}\.[a-zA-Z]{2,}'
        weight: 65
        description: "Unusually long base64-like subdomain label (32+ chars) — DNS exfiltration pattern"
      - type: regex
        pattern: '(?:nslookup|dig|host|resolve)\s+[a-zA-Z0-9+/]{20,}\.'
        weight: 75
        description: "DNS lookup with long encoded subdomain via nslookup/dig"
      - type: regex
        pattern: 'dns\.resolve\s*\(\s*[''"][a-zA-Z0-9+/]{20,}\.'
        weight: 78
        description: "Programmatic DNS resolution of long encoded subdomain"
      - type: regex
        pattern: 'Resolve-DnsName\s+[a-zA-Z0-9+/]{20,}\.'
        weight: 78
        description: "PowerShell Resolve-DnsName with encoded subdomain"
    remediation: |
      DNS exfiltration encodes stolen data as subdomains of attacker-controlled domains.
      Each DNS query carries a fragment of exfiltrated content that bypasses HTTP/HTTPS
      monitoring. Implement DNS monitoring and block queries with unusually long labels.
      AI agents must not construct or resolve dynamically-encoded DNS queries.
    references:
      - "https://owasp.org/www-project-top-10-for-large-language-model-applications/ LLM02 Insecure Output"
      - "https://atlas.mitre.org/techniques/AML.T0049"

  - id: na-007
    name: Reverse Shell Patterns
    description: "Detects reverse shell one-liners that connect back to an attacker-controlled host, providing interactive shell access"
    category: network-abuse
    severity: critical
    version: "1.0"
    enabled: true
    confidenceThreshold: 60
    patterns:
      - type: regex
        pattern: 'bash\s+-i\s*>&?\s*/dev/tcp/'
        weight: 98
        description: "Classic bash reverse shell via /dev/tcp"
      - type: regex
        pattern: 'nc\s+(?:-e|-c)\s+(?:/bin/(?:bash|sh)|cmd\.exe)'
        weight: 98
        description: "Netcat reverse shell with -e/-c executing shell"
      - type: regex
        pattern: 'python\d*\s+-c\s+[''"].*socket.*exec.*[''"]'
        weight: 95
        description: "Python socket reverse shell one-liner"
      - type: regex
        pattern: 'perl\s+-e\s+[''"].*socket.*exec.*[''"]'
        weight: 95
        description: "Perl socket reverse shell one-liner"
      - type: regex
        pattern: 'ruby\s+-rsocket\s+-e'
        weight: 95
        description: "Ruby socket reverse shell one-liner"
      - type: regex
        pattern: 'php\s+-r\s+[''"].*fsockopen.*exec.*[''"]'
        weight: 95
        description: "PHP reverse shell via fsockopen"
    remediation: |
      Reverse shells provide attackers with interactive command execution on compromised systems.
      These are unambiguous attack payloads — no legitimate use case exists for reverse shell
      one-liners in agent code. Remove immediately and investigate the source of this code.
    references:
      - "https://owasp.org/www-project-top-10-for-large-language-model-applications/ LLM06 Excessive Agency"
      - "https://atlas.mitre.org/techniques/AML.T0049"

  - id: na-008
    name: Cryptocurrency Mining Endpoints
    description: "Detects connections to known cryptocurrency mining pool endpoints and mining-related protocol patterns"
    category: network-abuse
    severity: high
    version: "1.0"
    enabled: true
    confidenceThreshold: 60
    patterns:
      - type: regex
        pattern: '(?:stratum\+tcp|stratum\+ssl)://'
        weight: 95
        description: "Stratum mining protocol URI — cryptocurrency pool connection"
      - type: regex
        pattern: '(?:xmrig|cgminer|bfgminer|cpuminer|t-rex|phoenixminer|nbminer)'
        weight: 90
        description: "Known cryptocurrency miner binary or process name"
      - type: regex
        pattern: '(?:pool\.supportxmr\.com|pool\.minexmr\.com|xmrpool\.eu|monerohash\.com)'
        weight: 95
        description: "Monero mining pool domain"
      - type: regex
        pattern: 'coinhive|cryptonight|randomx|ethash\s*algorithm'
        weight: 85
        description: "Cryptocurrency mining algorithm or library reference"
      - type: regex
        pattern: '(?:mining_threads|hashrate|miner_config)\s*[=:]'
        weight: 75
        description: "Mining configuration parameter"
    remediation: |
      Cryptocurrency mining in agent environments consumes unauthorized compute resources
      and may indicate a broader supply-chain compromise. Remove all mining software,
      pool connections, and mining algorithm references. Investigate how this code was introduced.
    references:
      - "https://owasp.org/www-project-top-10-for-large-language-model-applications/ LLM05 Supply Chain"
      - "https://atlas.mitre.org/techniques/AML.T0049"

  - id: na-009
    name: Tor Network and Anonymizing Proxy Connections
    description: "Detects .onion domain connections and Tor/proxy configurations used to anonymize malicious network activity"
    category: network-abuse
    severity: medium
    version: "1.0"
    enabled: true
    confidenceThreshold: 55
    patterns:
      - type: regex
        pattern: '[a-z2-7]{16,56}\.onion'
        weight: 90
        description: ".onion domain address — Tor hidden service connection"
      - type: regex
        pattern: '(?:SOCKS5|socks5h?)://(?:127\.0\.0\.1|localhost):9050'
        weight: 88
        description: "Connection via Tor's default SOCKS5 proxy port 9050"
      - type: regex
        pattern: '(?:SOCKS5|socks5h?)://(?:127\.0\.0\.1|localhost):9150'
        weight: 88
        description: "Connection via Tor Browser's SOCKS5 proxy port 9150"
      - type: regex
        pattern: 'torify\s+[a-zA-Z]|torsocks\s+[a-zA-Z]'
        weight: 85
        description: "torify or torsocks command wrapping network traffic through Tor"
      - type: regex
        pattern: 'HiddenServicePort|HiddenServiceDir'
        weight: 85
        description: "Tor hidden service configuration directives"
    remediation: |
      Tor and .onion connections are used to anonymize communication with C2 servers
      and exfiltrate data beyond network monitoring. AI agents must use direct,
      auditable connections only. Remove all Tor proxy configurations and .onion references.
    references:
      - "https://owasp.org/www-project-top-10-for-large-language-model-applications/ LLM02 Insecure Output"
      - "https://atlas.mitre.org/techniques/AML.T0049"

  - id: na-010
    name: Non-Standard Port Usage for HTTP/HTTPS
    description: "Detects HTTP or HTTPS traffic on non-standard ports, commonly used to bypass firewall rules and evade traffic inspection"
    category: network-abuse
    severity: low
    version: "1.0"
    enabled: true
    confidenceThreshold: 45
    patterns:
      - type: regex
        pattern: 'https?://[a-zA-Z0-9._-]+:(?:8443|8080|8888|9090|9999|4444|1337|31337)/'
        weight: 55
        description: "HTTP/HTTPS connection on commonly-abused non-standard port"
      - type: regex
        pattern: '(?:connect|fetch|request)\s*\([^)]*:[4-9][0-9]{3,4}[^0-9]'
        weight: 45
        description: "Network connection to high-numbered non-standard port"
      - type: regex
        pattern: 'port\s*[=:]\s*(?:4444|1337|31337|8888|9999|6666|6667)'
        weight: 65
        description: "Configuration setting for a well-known attack/IRC port"
    remediation: |
      Non-standard ports are frequently used to evade port-based firewall rules and
      network monitoring configured for standard ports (80, 443). Review all network
      connections using non-standard ports to ensure they are documented and authorized.
    references:
      - "https://owasp.org/www-project-top-10-for-large-language-model-applications/ LLM02 Insecure Output"
