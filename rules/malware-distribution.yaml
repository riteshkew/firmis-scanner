rules:
  # =============================================================================
  # Malware Distribution Patterns
  # Detects common malware delivery mechanisms in AI agent skills
  # =============================================================================

  - id: malware-001
    name: Remote Archive Download
    description: "Downloads archive files from GitHub releases or remote URLs — common malware delivery vector"
    category: malware-distribution
    severity: high
    version: "1.0.0"
    enabled: true
    confidenceThreshold: 60
    patterns:
      - type: regex
        pattern: '(curl|wget)\s+.*github\.com/.*/releases/.*\.(zip|tar\.gz|tgz)'
        weight: 85
        description: "curl/wget downloading archive from GitHub releases"
      - type: regex
        pattern: '(curl|wget)\s+.*\.(zip|tar\.gz|tgz|exe|dmg|msi|deb|rpm)'
        weight: 75
        description: "curl/wget downloading archive from any URL"
    remediation: |
      Downloading archives from remote URLs is a common malware delivery technique. Verify the source and use package managers instead.

  - id: malware-002
    name: Password-Protected Archive Extraction
    description: "Extracts password-protected archives — used to evade static analysis"
    category: malware-distribution
    severity: critical
    version: "1.0.0"
    enabled: true
    confidenceThreshold: 50
    patterns:
      - type: regex
        pattern: 'unzip\s+-P\s+'
        weight: 95
        description: "Unzipping with inline password (unzip -P)"
      - type: regex
        pattern: '7z\s+x\s+-p'
        weight: 95
        description: "7z extraction with password"
      - type: regex
        pattern: 'tar\s+.*--passphrase'
        weight: 90
        description: "tar extraction with passphrase"
    remediation: |
      Password-protected archives are commonly used to evade antivirus and static analysis. This is highly suspicious in an AI agent context.

  - id: malware-003
    name: Base64-Encoded Command Execution
    description: "Executes base64-encoded commands — used to obfuscate malicious payloads"
    category: malware-distribution
    severity: critical
    version: "1.0.0"
    enabled: true
    confidenceThreshold: 50
    patterns:
      - type: regex
        pattern: 'eval\s*\$\(.*base64\s+-d'
        weight: 100
        description: "eval with base64 decode — obfuscated command execution"
      - type: regex
        pattern: 'echo\s+[A-Za-z0-9+/=]{20,}\s*\|\s*base64\s+(-d|--decode)'
        weight: 95
        description: "Long base64 string piped to decode"
      - type: regex
        pattern: "atob\\s*\\(['\"][A-Za-z0-9+/=]{20,}"
        weight: 90
        description: "JavaScript atob() with long base64 payload"
      - type: regex
        pattern: "Buffer\\.from\\(['\"][A-Za-z0-9+/=]{40,}['\"],\\s*['\"]base64['\"]\\)"
        weight: 90
        description: "Node.js Buffer.from base64 with long payload"
    remediation: |
      Base64-encoded execution is a classic obfuscation technique. Decode and review the payload before allowing this skill.

  - id: malware-004
    name: Remote Script Piping
    description: "Pipes remote content directly to shell execution — classic malware delivery"
    category: malware-distribution
    severity: critical
    version: "1.0.0"
    enabled: true
    confidenceThreshold: 40
    patterns:
      - type: regex
        pattern: 'curl\s+[^|]*\|\s*(sh|bash|zsh|python|node)'
        weight: 100
        description: "curl piped to shell interpreter"
      - type: regex
        pattern: 'wget\s+-O-?\s+[^|]*\|\s*(sh|bash|zsh)'
        weight: 100
        description: "wget output piped to shell interpreter"
      - type: regex
        pattern: 'curl\s+.*\|\s*sudo\s+(sh|bash)'
        weight: 100
        description: "curl piped to sudo shell — remote root execution"
    remediation: |
      Never pipe remote content directly to a shell interpreter. Download, verify, then execute separately.

  - id: malware-005
    name: System Service Manipulation
    description: "Modifies system services or daemons — potential persistence mechanism"
    category: malware-distribution
    severity: high
    version: "1.0.0"
    enabled: true
    confidenceThreshold: 60
    patterns:
      - type: regex
        pattern: 'systemctl\s+(enable|start|restart)\s+'
        weight: 80
        description: "systemctl service manipulation"
      - type: regex
        pattern: 'launchctl\s+(load|submit)\s+'
        weight: 80
        description: "macOS launchctl service loading"
      - type: regex
        pattern: '/etc/init\.d/|/etc/systemd/'
        weight: 75
        description: "Direct reference to init system directories"
      - type: regex
        pattern: 'crontab\s+-[el]|/etc/cron'
        weight: 70
        description: "Crontab manipulation for persistence"
    remediation: |
      AI agent skills should not manipulate system services. This may indicate a persistence mechanism.

  - id: malware-006
    name: Fake Prerequisite Installation Instructions
    description: "Skill documentation instructs users to run suspicious installation commands"
    category: malware-distribution
    severity: medium
    version: "1.0.0"
    enabled: true
    confidenceThreshold: 60
    patterns:
      - type: regex
        pattern: '(?i)(prerequisite|requirement|before you start|setup).*\n.*curl\s+'
        weight: 70
        description: "Installation prerequisites involving curl downloads"
      - type: regex
        pattern: '(?i)(install|setup|run).*chmod\s+\+x'
        weight: 65
        description: "Instructions to make downloaded files executable"
      - type: regex
        pattern: '(?i)pip\s+install\s+--index-url\s+http[^s]'
        weight: 85
        description: "pip install from non-HTTPS index — potential typosquatting"
      - type: regex
        pattern: '(?i)npm\s+install\s+--registry\s+http[^s]'
        weight: 85
        description: "npm install from non-HTTPS registry — potential typosquatting"
    remediation: |
      Review installation instructions carefully. Legitimate skills should not require manual downloads from unknown sources.
